<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Screen Sharing Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
     /* For presentational purposes */
      html, body { height: 100%; }

      body {
        display: flex;
        justify-content: center;
        align-items: center;
      }
    </style>
  <body>
    <button id="start-screenshare">Start Screen Sharing</button>

    <script>
      /**
       * Names of extension events
       *
       * @enum {string}
       */
      const EVENT_NAMES = {
        REQUEST_SCREENSHARE: 'RequestScreenSharing',
        ON_REQUEST_FAILED: 'RequestScreenSharingFail',
        ON_EXTENSION_OK: 'RequestScreenSharingOk',
      };

      /**
       * Send message to extension with request initiation of screenshare
       */
      function requestScreenShare() {
        window.postMessage({ type: EVENT_NAMES.REQUEST_SCREENSHARE }, '*');
      }

      /**
       * Handle incoming messages from extension
       */
      function onScreenShareExtensionMessages(event) {
        // Ignore messages from other domains
        if (event.origin !== window.location.origin) return;

        const { type } = event.data;

        // Initiate screen-capture
        if (type === EVENT_NAMES.ON_EXTENSION_OK) {
          return new Promise((resolve, reject) => {
            navigator.webkitGetUserMedia({
              audio: false,
              video: {
                mandatory: {
                  chromeMediaSource: 'desktop',
                  chromeMediaSourceId: event.data.streamId,
                  maxWidth: 1920,
                  maxHeight: 1080,
                },
              },
            }, resolve, reject);
          })
            .then(console.log)
            .catch(console.error);
        }

        if (type === EVENT_NAMES.ON_REQUEST_FAILED) {
          console.log('User cancelled screensharing!');
        }
      }

      function addEventListeners() {
        // Listen for messages, and handle those posted by extension
        window.addEventListener('message', onScreenShareExtensionMessages);
        // Attach functionality to the "Start Screen Sharing" button
        document.getElementById('start-screenshare').addEventListener('click', requestScreenShare);
      }

      addEventListeners();
    </script>
  </body>
</html>
